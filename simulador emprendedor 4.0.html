<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Viaje del Emprendedor 4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .boat-icon { 
            font-size: 2.5rem; 
            transition: transform 0.5s ease-out; /* Mantenemos la transici√≥n de movimiento base */
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            z-index: 5; /* Asegura que el barco est√© sobre los marcadores */
        }
        .boat-icon:hover { transform: scale(1.1); }
        .sea-bg {
            background: linear-gradient(to top, #4fa3d1, #7ec0e5);
            height: 150px;
            border-top: 5px solid #0056b3;
            border-bottom: 5px solid #0056b3;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5%;
            position: relative; /* CR√çTICO: Necesario para posicionar los marcadores */
            overflow: hidden; /* Evita que el barco se vea saliendo por abajo al hundirse */
        }
        /* Estilos de los Marcadores de Decisi√≥n */
        .marker {
            position: absolute;
            top: -10px; /* Posiciona sobre la l√≠nea de flotaci√≥n */
            font-size: 1.5rem;
            cursor: help; /* Indica interactividad (tooltip) */
            transform: translateX(-50%); /* Centra el √≠cono sobre el punto */
            transition: opacity 0.3s;
            z-index: 2; /* Debajo del barco */
        }
        .marker:hover .marker-label {
            opacity: 1;
        }
        .marker-label {
            position: absolute;
            bottom: 100%; /* Arriba del √≠cono */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none; /* Permite hacer clic a trav√©s de √©l si no est√° visible */
            transition: opacity 0.3s;
            font-size: 0.75rem;
            text-align: center;
        }

        /* Custom scrollbar for better aesthetics */
        .log-container {
            max-height: 250px;
            overflow-y: auto;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .log-container::-webkit-scrollbar { width: 8px; }
        .log-container::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        .log-container::-webkit-scrollbar-thumb:hover { background: #2563eb; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col">

    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800">üö¢ El Viaje del Emprendedor 4.0</h1>
        <p class="text-gray-600 mt-2">Define tu mentalidad, planifica tu ruta y navega los desaf√≠os de la Industria 4.0.</p>
    </header>

    <!-- Panel de Control y Estado -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border-t-4 border-blue-500">
        <h2 class="text-xl font-semibold mb-4 text-blue-700">Estado de la Misi√≥n</h2>
        <div class="grid grid-cols-3 gap-4">
            <div>
                <p class="text-sm text-gray-500">Distancia Recorrida</p>
                <p id="distance" class="text-2xl font-bold text-gray-800">0 km</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Puntuaci√≥n Decisiones</p>
                <p id="scoreDisplay" class="text-2xl font-bold text-green-600">0 pts</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Desaf√≠os Completados</p>
                <p id="challengesCompletedDisplay" class="text-2xl font-bold text-orange-600">0/10</p>
            </div>
        </div>
    </div>

    <!-- Interfaz de Planificaci√≥n y Acci√≥n -->
    <div id="controls" class="bg-white p-6 rounded-xl shadow-lg mb-6 border-t-4 border-green-500">
        <h2 class="text-xl font-semibold mb-4 text-green-700">Comenzar el Viaje (Mentalidad y Planificaci√≥n)</h2>

        <!-- Input para la Mentalidad Inicial -->
        <div class="mb-4">
            <label for="routeInput" class="block text-sm font-medium text-gray-700 mb-2">1. Define tu Puerto Destino (Tu Objetivo/Modelo de Negocio)</label>
            <input type="text" id="routeInput" placeholder="Ej: Ser la panader√≠a l√≠der en IA para 2026." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Bot√≥n de Inicio y Barco -->
        <button id="startButton" onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md hover:shadow-lg">
            Zarpar (Iniciar Simulaci√≥n)
        </button>
        
        <!-- Zona de Simulaci√≥n Visual -->
        <div class="sea-bg mt-6 rounded-lg">
            <span class="text-3xl md:text-4xl">‚öì</span>
            <span id="boatIcon" class="boat-icon">üö¢</span>
            <span class="text-3xl md:text-4xl">üèùÔ∏è</span>
        </div>
    </div>

    <!-- Log de Eventos y Desaf√≠os -->
    <div class="flex-grow">
        <h2 class="text-xl font-semibold mb-2 text-gray-700">Bit√°cora de Eventos (Desaf√≠os y Decisiones)</h2>
        <div id="log" class="log-container">
            <p class="text-gray-500 italic">Esperando que el Capit√°n defina su ruta y zarpe...</p>
        </div>
    </div>

    <!-- Modal para Desaf√≠os (Dise√±o Thinking / 6 Sombreros) -->
    <div id="challengeModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-yellow-500">
            <!-- Contenido din√°mico para desaf√≠os o resultados -->
            <h3 class="text-2xl font-bold mb-4 text-yellow-700">üö® DESAF√çO EN EL OC√âANO üö®</h3>
            <p id="challengeText" class="mb-6 text-gray-700">Texto del desaf√≠o...</p>
            
            <div id="decisionButtons" class="space-y-3">
                <!-- Los botones de decisi√≥n se insertar√°n aqu√≠ -->
            </div>
            
            <p class="text-xs text-gray-500 mt-4">
                *Esto simula una toma de decisi√≥n r√°pida, aplicando los principios de Design Thinking o los 6 Sombreros.
            </p>
        </div>
    </div>

    <script>
        // --- VARIABLES DE ESTADO ---
        let gameActive = false;
        let distance = 0;
        let score = 0; // Puntuaci√≥n basada en decisiones
        let logIndex = 0;
        let challengesCompleted = 0; // Contador de desaf√≠os
        let challengeActive = false; // Bandera para un solo modal activo
        let intervalId;
        let nextChallengeDistance = 9; // Distancia para el pr√≥ximo desaf√≠o (9km, 18km, 27km...)
        
        // Almacena las decisiones tomadas para marcarlas en el mapa
        let decisionMarkers = []; 
        // Almacena el desaf√≠o actual mientras el modal est√° abierto
        let currentChallengeData = null; 
        
        // El icono del barco que se mueve
        const boatIcon = document.getElementById('boatIcon');
        const startButton = document.getElementById('startButton');
        const routeInput = document.getElementById('routeInput');
        
        // DOM para estad√≠sticas
        const distanceDisplay = document.getElementById('distance');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const challengesCompletedDisplay = document.getElementById('challengesCompletedDisplay');
        const logContainer = document.getElementById('log');

        // Modal y Desaf√≠os
        const challengeModal = document.getElementById('challengeModal');
        const challengeText = document.getElementById('challengeText');
        const decisionButtonsContainer = document.getElementById('decisionButtons');
        
        // --- DATOS DEL JUEGO (10 Desaf√≠os √önicos) ---
        const CHALLENGES = [
            {
                icon: 'üêô', // Pulpo de Datos / Competidor IA
                text: "El **Barco Competidor 4.0** (que usa IA para segmentar) ha triplicado sus ventas y est√° robando tus clientes. ¬øInviertes en **Gemini Workspace** para analizar tus datos (IA) o recortas gastos de marketing (Mentalidad de escasez)?",
                theme: "Inteligencia Artificial (IA) / B√∫squeda de Clientes",
                decisions: [
                    { label: "Opci√≥n A: Invertir en IA/Gemini (Optimizaci√≥n)", effect: { score: 1 }, result: "¬°Movida maestra! La IA identific√≥ un nicho de clientes no explorado. Rentabilidad asegurada." },
                    { label: "Opci√≥n B: Recortar Marketing (Miedo al Gasto)", effect: { score: -1.5 }, result: "El competidor sigue creciendo. Tu visibilidad se redujo a cero, aumentando la desventaja." }
                ]
            },
            {
                icon: 'üå©Ô∏è', // Tormenta / Escasez Financiera
                text: "Los recursos financieros est√°n cr√≠ticos (quedan 2 meses de capital). ¬øBuscas una inyecci√≥n de capital r√°pida (Sacrificar acciones) o aplicas los **6 Sombreros para Pensar** en la optimizaci√≥n de procesos (Disciplina/Rentabilidad)?",
                theme: "Escasez de Recursos Financieros / 6 Sombreros para Pensar",
                decisions: [
                    { label: "Opci√≥n A: Inyecci√≥n de Capital (Soluci√≥n a corto plazo)", effect: { score: -1.5 }, result: "Ganaste tiempo, pero perdiste control (acciones). Dependencia externa." },
                    { label: "Opci√≥n B: Optimizar con 6 Sombreros (Disciplina)", effect: { score: 1 }, result: "Descubriste procesos ineficientes y los eliminaste. Lograste extender el capital sin ceder control." }
                ]
            },
            {
                icon: 'üßä', // Iceberg / Producto Fallido (Falta de datos)
                text: "Los **datos de prueba del producto** indican que los clientes no est√°n satisfechos con una caracter√≠stica clave. ¬øIgnoras los datos y sigues (Falta de compromiso) o usas **Design Thinking** para pivotar la caracter√≠stica y mejorar el producto?",
                theme: "Mejora de Producto / Design Thinking / Compromiso",
                decisions: [
                    { label: "Opci√≥n A: Ignorar los datos (Falta de Disciplina)", effect: { score: -1.5 }, result: "El producto se vuelve irrelevante para el mercado. Las ventas caen." },
                    { label: "Opci√≥n B: Pivotar con Design Thinking (Compromiso)", effect: { score: 1 }, result: "La iteraci√≥n r√°pida mejor√≥ la retenci√≥n de clientes. Avance significativo." }
                ]
            },
            {
                icon: '‚öôÔ∏è', // Motor Averiado (Desaf√≠o T√©cnico)
                text: "El motor principal del barco fall√≥ repentinamente. ¬øContratas un equipo de reparaci√≥n externo inmediatamente (alto costo, soluci√≥n r√°pida) o usas tutoriales en l√≠nea y tu equipo interno (ahorro, pero p√©rdida de tiempo valioso)?",
                theme: "Desaf√≠o T√©cnico / Gesti√≥n de Crisis",
                decisions: [
                    { label: "Opci√≥n A: Contratar experto (Proactivo)", effect: { score: 1 }, result: "El motor fue reparado r√°pidamente. El costo fue alto, pero se minimiz√≥ la p√©rdida de tiempo en el mercado." },
                    { label: "Opci√≥n B: Reparaci√≥n interna (Demora y riesgo de error)", effect: { score: -1.5 }, result: "La reparaci√≥n interna se demor√≥ dos semanas m√°s de lo esperado y gener√≥ m√°s errores, perdiendo oportunidades." }
                ]
            },
            {
                icon: 'üß±', // Resistencia al Cambio (Equipo)
                text: "Parte de tu tripulaci√≥n (empleados) se resiste a usar las nuevas herramientas de automatizaci√≥n. ¬øLos capacitas intensivamente y les das tiempo para adaptarse (inversi√≥n en talento) o los reemplazas por personal nuevo y digitalizado (ruptura cultural)?",
                theme: "Gesti√≥n del Cambio / Talento 4.0",
                decisions: [
                    { label: "Opci√≥n A: Capacitaci√≥n intensiva (Inversi√≥n en talento)", effect: { score: 1 }, result: "La tripulaci√≥n se sinti√≥ valorada y el conocimiento interno se mantuvo. La adopci√≥n fue exitosa a largo plazo." },
                    { label: "Opci√≥n B: Reemplazo inmediato (Ruptura cultural)", effect: { score: -1.5 }, result: "El reemplazo caus√≥ baja moral y p√©rdida de conocimiento institucional. El barco es r√°pido, pero la tripulaci√≥n inexperta." }
                ]
            },
            {
                icon: 'üëæ', // Cyberataque (Seguridad 4.0)
                text: "Sufres un intento de ciberataque a tus datos sensibles de clientes. ¬øInviertes en un sistema de seguridad de vanguardia (prevenci√≥n proactiva) o ignoras la alarma pensando que 'no volver√° a pasar' (riesgo latente)?",
                theme: "Ciberseguridad / Protecci√≥n de Datos",
                decisions: [
                    { label: "Opci√≥n A: Invertir en seguridad avanzada", effect: { score: 1 }, result: "Refuerzos de seguridad instalados. Est√°s protegido contra futuros ataques, manteniendo la confianza de los clientes." },
                    { label: "Opci√≥n B: Ignorar la alarma", effect: { score: -1.5 }, result: "El barco fue vulnerable a un segundo ataque, perdiendo datos valiosos y enfrentando multas por incumplimiento." }
                ]
            },
            {
                icon: 'üö®', // Saturaci√≥n del Mercado (Oc√©ano Rojo)
                text: "Descubres que el mercado al que apuntas est√° saturado de ofertas similares a la tuya. ¬øMantienes el rumbo con precios bajos (guerra de precios) o usas la mentalidad de **Oc√©ano Azul** para redefinir tu propuesta de valor?",
                theme: "Estrategia de Mercado / Oc√©ano Azul",
                decisions: [
                    { label: "Opci√≥n A: Redefinir propuesta (Oc√©ano Azul)", effect: { score: 1 }, result: "Encontraste un espacio de mercado nuevo y sin competencia. Tu barco navega en aguas claras y tranquilas." },
                    { label: "Opci√≥n B: Guerra de precios", effect: { score: -1.5 }, result: "Entraste en una guerra de precios que deval√∫a tu producto y quema tus m√°rgenes de beneficio." }
                ]
            },
            {
                icon: 'üöÄ', // Tendencia Tecnol√≥gica Disruptiva
                text: "Una nueva tecnolog√≠a (ej. realidad aumentada) amenaza con dejar obsoleto tu producto en 6 meses. ¬øDedicas el 50% de tu tiempo a I+D para integrarla (innovaci√≥n) o esperas a ver si la tendencia 'pega' (pasividad)?",
                theme: "Innovaci√≥n y Adaptabilidad",
                decisions: [
                    { label: "Opci√≥n A: Invertir en I+D (Innovaci√≥n)", effect: { score: 1 }, result: "Adoptaste la tecnolog√≠a tempranamente, posicion√°ndote como l√≠der del mercado y asegurando el futuro del proyecto." },
                    { label: "Opci√≥n B: Esperar a ver (Pasividad)", effect: { score: -1.5 }, result: "La tecnolog√≠a se populariz√≥, dejando tu producto en desventaja y oblig√°ndote a un costoso y tard√≠o proceso de adaptaci√≥n." }
                ]
            },
            {
                icon: 'üé≠', // Conflicto de Liderazgo (6 Sombreros)
                text: "Dos l√≠deres de √°rea tienen un conflicto que est√° paralizando la toma de decisiones clave. ¬øTomas la decisi√≥n por ellos (autoritarismo) o facilitas una sesi√≥n con los **6 Sombreros para Pensar** para resolver el conflicto de manera objetiva?",
                theme: "Liderazgo y Resoluci√≥n de Conflictos",
                decisions: [
                    { label: "Opci√≥n A: Facilitar 6 Sombreros (Objetividad)", effect: { score: 1 }, result: "El conflicto se resolvi√≥, mejorando la comunicaci√≥n y empoderando a los l√≠deres en la toma de decisiones futura." },
                    { label: "Opci√≥n B: Decidir unilateralmente (Autoritarismo)", effect: { score: -1.5 }, result: "Resolviste el problema inmediato, pero generaste resentimiento y socavaste la autonom√≠a de tus l√≠deres." }
                ]
            },
            {
                icon: 'üì£', // Crisis de Reputaci√≥n (Viralidad Negativa)
                text: "Un cliente influyente publica una rese√±a negativa que se vuelve viral. ¬øIntentas silenciar la rese√±a con una demanda (agresividad) o aplicas **Design Thinking** para entender el problema, disculparte y ofrecer una soluci√≥n p√∫blica y r√°pida?",
                theme: "Gesti√≥n de la Reputaci√≥n / Empat√≠a",
                decisions: [
                    { label: "Opci√≥n A: Disculparse y aplicar DT (Empat√≠a)", effect: { score: 1 }, result: "La respuesta honesta y proactiva convirti√≥ al cliente en un defensor y mejor√≥ la imagen de la marca." },
                    { label: "Opci√≥n B: Intentar silenciar (Agresividad)", effect: { score: -1.5 }, result: "La demanda gener√≥ m√°s controversia y da√±√≥ irreparablemente la percepci√≥n p√∫blica de tu proyecto." }
                ]
            }
        ];
        
        // --- FUNCIONES PRINCIPALES ---

        /** Inicia o detiene el juego */
        function startGame() {
            if (!gameActive) {
                const destination = routeInput.value.trim();
                if (destination.length < 5) {
                    showCustomModal("Error al Zarpar", "Define tu destino primero, Capit√°n. (M√≠nimo 5 caracteres)");
                    return;
                }
                
                // RESTABLECER ESTILOS DEL BARCO AL INICIAR
                boatIcon.style.transition = 'transform 0.5s ease-out';
                boatIcon.style.opacity = '1';
                
                // Resetear el estado y marcadores
                distance = 0;
                score = 0;
                logIndex = 0;
                challengesCompleted = 0;
                challengeActive = false;
                decisionMarkers = []; // Reinicia los marcadores
                logContainer.innerHTML = '';
                nextChallengeDistance = 9; // El primer desaf√≠o es al km 9
                
                updateLog(`‚öì ¬°Zarpando! Destino: **${destination}** (Tu Modelo de Negocio).`);
                updateLog("El motor 4.0 est√° encendido. La misi√≥n ha comenzado.");
                
                gameActive = true;
                startButton.textContent = "Hacer Escala (Detener)";
                startButton.classList.remove('bg-blue-600');
                startButton.classList.add('bg-red-600');
                
                // Iniciar el ciclo de avance continuo
                intervalId = setInterval(advanceStep, 3000); // Avanza cada 3 segundos
            } else {
                // Detener el juego (Hacer Escala)
                clearInterval(intervalId);
                gameActive = false;
                startButton.textContent = "Zarpar (Reiniciar Simulaci√≥n)";
                startButton.classList.remove('bg-red-600');
                startButton.classList.add('bg-blue-600');
                
                updateLog(`üö© ¬°Misi√≥n Pausada! Distancia total: ${distance} km. Puntuaci√≥n: ${score.toFixed(1)} pts.`, "bg-yellow-100 text-yellow-800 p-2 font-semibold");
                
                // Si el usuario pausa antes de terminar, no se ejecuta endGame, solo se detiene.
            }
            updateStatus();
        }

        /** Procesa el avance en el tiempo y dispara eventos */
        function advanceStep() {
            // DETENER AVANCE si hay un desaf√≠o activo 
            if (challengeActive) {
                 // Mantener la posici√≥n visual, pero sin avanzar
                const visualDistance = Math.min(distance, 100); 
                const progress = (visualDistance / 100) * 80 + 10; 
                boatIcon.style.transform = `translateX(${progress}%)`;
                return; 
            }
            
            logIndex++;
            
            // Simular avance pasivo 
            const baseAdvance = 2 + Math.floor(Math.random() * 3); // 2-4 km base
            distance += baseAdvance;
            
            // Si la distancia supera 100km, la fijamos en 100 para el log visual.
            if (distance > 100) {
                distance = 100;
            }

            updateStatus();
            
            // Log de avance diferenciado
            if (challengesCompleted < CHALLENGES.length) {
                updateLog(`‚úÖ Paso ${logIndex}: Avanzamos ${baseAdvance} km en aguas tranquilas.`);
            } else if (distance < 100) {
                 updateLog(`üöÄ Avance post-evaluaci√≥n: Avanzamos ${baseAdvance} km hacia el Puerto Final (100 km).`);
            }
            

            // Chequear si se ha alcanzado la distancia del pr√≥ximo desaf√≠o (cada 9 km)
            if (challengesCompleted < CHALLENGES.length && !challengeActive && distance >= nextChallengeDistance) {
                showChallenge();
            }

            // Condici√≥n de fin de juego: 10 desaf√≠os completados Y llegar a 100km. (ACTUALIZADO)
            if (challengesCompleted >= CHALLENGES.length && distance >= 100) {
                endGame();
                return; 
            }
            
            // Mover el barco visualmente (simulaci√≥n de progreso)
            const visualDistance = distance; 
            const progress = (visualDistance / 100) * 80 + 10; // De 10% a 90%
            boatIcon.style.transform = `translateX(${progress}%)`;
        }

        /** Muestra el modal del desaf√≠o */
        function showChallenge() {
            // Usa el √≠ndice de desaf√≠o completado para obtener el siguiente desaf√≠o de la lista
            if (challengesCompleted >= CHALLENGES.length) return;

            challengeActive = true; // Activa la bandera para detener el avance
            currentChallengeData = CHALLENGES[challengesCompleted]; 
            const challenge = currentChallengeData;

            // Asegura que el modal de desaf√≠o tenga el borde amarillo
            const modalContent = challengeModal.querySelector('.bg-white');
            modalContent.classList.remove('border-blue-500');
            modalContent.classList.add('border-yellow-500');


            challengeText.innerHTML = `**Desaf√≠o ${challengesCompleted + 1} de ${CHALLENGES.length}**<br>
                                        **Tema:** ${challenge.theme}<br><br>${challenge.text}`;
            decisionButtonsContainer.innerHTML = '';

            challenge.decisions.forEach((decision) => {
                const button = document.createElement('button');
                
                // Limpiar el texto: eliminar contenido entre par√©ntesis 
                const cleanLabel = decision.label.replace(/\s*\([^)]*\)\s*/g, '');
                
                button.textContent = cleanLabel; 
                button.className = 'w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200';
                // Pasamos el objeto decision y el originalChallenge al manejador
                button.onclick = () => handleDecision(decision, currentChallengeData); 
                decisionButtonsContainer.appendChild(button);
            });

            challengeModal.classList.remove('hidden');
        }

        /** Procesa la decisi√≥n del usuario en el desaf√≠o */
        function handleDecision(decision, originalChallenge) {
            // Actualiza la puntuaci√≥n
            score += decision.effect.score;
            
            // Almacenar la decisi√≥n para marcarla en el mapa
            if (currentChallengeData) {
                decisionMarkers.push({
                    distance: distance, // La distancia D√ìNDE se tom√≥ la decisi√≥n
                    icon: currentChallengeData.icon,
                    theme: currentChallengeData.theme,
                    result: decision.label.replace(/\s*\([^)]*\)\s*/g, ''), // Almacenar label limpio
                    score: decision.effect.score
                });
                currentChallengeData = null; // Limpiar despu√©s de usar
            }

            challengesCompleted++; // Contabiliza el desaf√≠o completado
            challengeActive = false; // Desactiva la bandera para reanudar el avance
            
            // --- ACTUALIZACI√ìN DE DISTANCIA DEL DESAF√çO ---
            if (challengesCompleted < CHALLENGES.length) {
                // El siguiente desaf√≠o ser√° al m√∫ltiplo de 9 que sigue
                nextChallengeDistance = (challengesCompleted + 1) * 9; 
                updateLog(`üó∫Ô∏è Pr√≥ximo desaf√≠o programado para el kil√≥metro ${nextChallengeDistance}.`);
            } else {
                nextChallengeDistance = 9999; // Asegura que no se dispare otro desaf√≠o 
            }


            // --- LOG DETALLADO Y COMPLETO ---
            let detailedLog = `<div class="bg-gray-100 p-3 rounded my-2 border-l-4 border-yellow-500">`;
            detailedLog += `<p class="font-bold text-lg text-yellow-700">üö¢ Desaf√≠o ${challengesCompleted} resuelto en ${distance} km</p>`;
            detailedLog += `<p class="text-sm italic mb-3">Tema: ${originalChallenge.theme}</p>`;
            detailedLog += `<p class="mb-3">${originalChallenge.text}</p>`;
            detailedLog += `<p class="font-semibold mb-2">Opciones y Tu Decisi√≥n:</p>`;

            originalChallenge.decisions.forEach(opt => {
                const cleanLabel = opt.label.replace(/\s*\([^)]*\)\s*/g, '');
                const scoreText = opt.effect.score > 0 ? `+${opt.effect.score.toFixed(1)}` : opt.effect.score.toFixed(1);
                
                let optionLine = `<span class="text-gray-600">${cleanLabel}</span>`;

                if (opt.label === decision.label) {
                    // Resaltar la seleccionada en negrita y a√±adir puntaje (NUEVO REQUERIMIENTO)
                    optionLine = `‚û°Ô∏è <span class="font-extrabold text-blue-700">${cleanLabel}</span> | Puntaje: ${scoreText} pts`;
                } else {
                    optionLine = `<span class="text-gray-600">${cleanLabel}</span> | Puntaje: ${scoreText} pts`;
                }

                detailedLog += `<p class="text-xs ml-4 mb-1">${optionLine}</p>`;
            });

            detailedLog += `<p class="mt-3 font-semibold">Consecuencia: ${decision.result}</p>`;
            detailedLog += `<p class="mt-3 font-bold text-right text-md text-blue-700 border-t pt-2 border-gray-300">Puntaje Total Acumulado: ${score.toFixed(1)} pts</p>`;
            detailedLog += `</div>`;
            
            updateLog(detailedLog, 'p-0 mb-1'); 
            
            updateStatus();
            challengeModal.classList.add('hidden');
            
            // Chequear si se alcanzaron los 10 desaf√≠os Y la distancia final (la distancia se chequea en advanceStep)
            // No hacemos nada si challengesCompleted == 10, solo se reanuda el avance.
        }

        /** Clasifica la puntuaci√≥n final seg√∫n los rangos definidos. */
        function getScoreClassification(finalScore) {
            if (finalScore >= 10) {
                return {
                    category: "Emprendedor alineado a la 4.0",
                    message: "¬°Felicitaciones! Tu mentalidad de liderazgo es excelente y proactiva."
                };
            } else if (finalScore >= 7) { // Implica entre 7.0 y 9.5
                return {
                    category: "Emprendedor 4.0 con conocimientos b√°sicos",
                    message: "¬°Vas por buen camino! Tienes una base s√≥lida, sigue desarrollando tu visi√≥n."
                };
            } else if (finalScore >= 4) { // Implica entre 4.0 y 6.5
                return {
                    category: "El curso de Emprendedor 4.0 es ideal para ti",
                    message: "¬°Bienvenido! Tienes la intenci√≥n, pero necesitas afianzar tus herramientas de decisi√≥n (Design Thinking, 6 Sombreros)."
                };
            } else if (finalScore >= 1) { // Implica entre 1.0 y 3.5
                return {
                    category: "Emprendedor candidato a Consultor√≠a con Hitos de Inflexi√≥n",
                    message: "Reserva una Cita. Tuviste algunas decisiones proactivas, pero los retrocesos fueron muy costosos."
                };
            } else { // Menos de 1.0 (incluyendo negativos)
                return {
                    category: "Necesito el Sombrero de Harry Potter",
                    message: "Tu mentalidad actual es demasiado pasiva o reactiva. ¬°Hay mucho potencial por liberar!"
                };
            }
        }

        /** Genera el contenido HTML de la tabla de resultados final. */
        function generateResultsTableHTML(finalScore, classification) {
            let tableContent = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg shadow-inner bg-gray-50 border border-gray-200">
                        <p class="text-sm font-semibold text-gray-500">Puntuaci√≥n Final</p>
                        <p class="text-4xl font-extrabold ${finalScore > 0 ? 'text-green-600' : 'text-red-600'}">${finalScore.toFixed(1)} pts</p>
                    </div>
                    
                    <div class="p-4 rounded-lg shadow-md border-2 border-blue-500 bg-blue-50">
                        <p class="text-lg font-bold text-blue-800 mb-1">Tu Clasificaci√≥n:</p>
                        <p class="text-xl font-bold">${classification.category}</p>
                        <p class="text-sm mt-1 text-gray-700">${classification.message}</p>
                    </div>

                    <h4 class="text-xl font-semibold mt-6 text-gray-700 border-b pb-2">Resumen Detallado de Decisiones:</h4>
                    
                    <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-blue-500 text-white">
                            <tr>
                                <th class="px-2 py-2 text-left text-xs font-medium uppercase tracking-wider">#</th>
                                <th class="px-2 py-2 text-left text-xs font-medium uppercase tracking-wider">Km</th>
                                <th class="px-2 py-2 text-left text-xs font-medium uppercase tracking-wider">Tema</th>
                                <th class="px-2 py-2 text-left text-xs font-medium uppercase tracking-wider">Decisi√≥n</th>
                                <th class="px-2 py-2 text-left text-xs font-medium uppercase tracking-wider">Puntos</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-xs">
            `;
            
            // Llenar la tabla con decisionMarkers
            decisionMarkers.forEach((marker, index) => {
                const scoreColor = marker.score > 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                tableContent += `
                    <tr>
                        <td class="px-2 py-2 font-bold">${index + 1}</td>
                        <td class="px-2 py-2 whitespace-nowrap">${marker.distance} km</td>
                        <td class="px-2 py-2">${marker.theme}</td>
                        <td class="px-2 py-2">${marker.result}</td>
                        <td class="px-2 py-2 ${scoreColor} whitespace-nowrap">${marker.score > 0 ? '+' : ''}${marker.score.toFixed(1)}</td>
                    </tr>
                `;
            });
            
            tableContent += `
                        </tbody>
                    </table>
                    </div>
                </div>
            `;
            return tableContent;
        }


        /** Actualiza los indicadores de estado y dibuja los marcadores en el mapa */
        function updateStatus() {
            distanceDisplay.textContent = `${distance} km`;
            scoreDisplay.textContent = `${score.toFixed(1)} pts`; // Mostrar con un decimal
            challengesCompletedDisplay.textContent = `${challengesCompleted}/${CHALLENGES.length}`;

            // Cambiar color de score si es bajo (simulando riesgo conceptual)
            if (score <= 0) {
                scoreDisplay.classList.add('text-red-600');
                scoreDisplay.classList.remove('text-green-600');
            } else {
                scoreDisplay.classList.remove('text-red-600');
                scoreDisplay.classList.add('text-green-600');
            }
            
            renderMarkers(); // LLAMADO PARA ACTUALIZAR LOS MARCADORES VISUALES
        }
        
        /** Dibuja los marcadores de decisiones en la barra de progreso */
        function renderMarkers() {
            const seaBg = document.querySelector('.sea-bg');
            
            // Elimina marcadores existentes
            seaBg.querySelectorAll('.marker').forEach(m => m.remove());

            decisionMarkers.forEach(marker => {
                // C√°lculo de la posici√≥n: convierte distancia (max 100) a porcentaje (10% a 90% del contenedor)
                const visualDistance = Math.min(marker.distance, 100); 
                const progressPercent = (visualDistance / 100) * 80 + 10; 

                // Crea el elemento marcador
                const markerDiv = document.createElement('div');
                markerDiv.className = 'marker';
                markerDiv.style.left = `${progressPercent}%`;
                
                // A√±adir color de puntuaci√≥n al √≠cono
                const scoreColor = marker.score > 0 ? 'text-green-400' : 'text-red-400';
                
                // Tooltip/Etiqueta (Muestra la informaci√≥n de la decisi√≥n)
                const label = document.createElement('span');
                label.className = 'marker-label shadow-xl';
                // Mostrar puntaje en el tooltip para evaluaci√≥n posterior
                label.innerHTML = `
                    <span class="${scoreColor} font-bold">${marker.score > 0 ? '+' : ''}${marker.score.toFixed(1)} pts</span><br>
                    **${marker.icon} ${marker.theme}**<br>
                    Decisi√≥n: ${marker.result}
                `;

                // √çcono de obst√°culo
                const iconSpan = document.createElement('span');
                iconSpan.textContent = marker.icon;
                
                markerDiv.appendChild(iconSpan);
                markerDiv.appendChild(label);
                
                // Inserta antes del √≠cono del barco para que el barco se vea encima
                seaBg.insertBefore(markerDiv, boatIcon);
            });
        }

        /** Agrega un mensaje a la bit√°cora */
        function updateLog(message, className = 'text-gray-700') {
            const p = document.createElement('p');
            // Mantiene el formato de Bit√°cora para el timestamp
            p.innerHTML = `<span class="text-xs text-gray-400 mr-2">${new Date().toLocaleTimeString()}</span>${message}`;
            p.className = `text-sm mb-1 ${className}`;
            logContainer.prepend(p); // A√±adir al inicio para ver lo m√°s reciente
        }

        /** Muestra un modal personalizado, usado para alertas o el resultado final. */
        function showCustomModal(title, contentHTML, isFinalResult = false) {
            const modal = document.getElementById('challengeModal');
            const contentDiv = modal.querySelector('.bg-white');
            
            // Limpiar el contenido previo y rellenar
            contentDiv.innerHTML = `
                <h3 class="text-2xl font-bold mb-4 ${isFinalResult ? 'text-blue-800' : 'text-yellow-700'}">${isFinalResult ? 'üìä RESULTADOS FINALES DE LA SIMULACI√ìN' : title}</h3>
                
                <div class="mb-6 text-gray-700 space-y-3">
                    ${contentHTML}
                </div>

                <button onclick="document.getElementById('challengeModal').classList.add('hidden')" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4">
                    Cerrar
                </button>
            `;
            // Ajustar el color del borde superior del modal para el resultado final
            if (isFinalResult) {
                contentDiv.classList.remove('border-yellow-500');
                contentDiv.classList.add('border-blue-500');
            } else {
                 contentDiv.classList.remove('border-blue-500');
                contentDiv.classList.add('border-yellow-500');
            }

            modal.classList.remove('hidden');
        }

        /** Finaliza el juego y muestra el resultado (A√±ade navegaci√≥n hasta 100km) */
        function endGame() {
            clearInterval(intervalId);
            gameActive = false;
            
            // Si el juego finaliza por alcanzar los 10 desaf√≠os y 100km
            if (challengesCompleted >= CHALLENGES.length && distance >= 100) {
                const finalScore = score;
                const classification = getScoreClassification(finalScore);
                
                // 1. Log en la bit√°cora
                updateLog(`üèÅ **FIN DE LA SIMULACI√ìN.** Evaluaci√≥n de mentalidad completada. Puntuaci√≥n Final: ${finalScore.toFixed(1)} pts. Clasificaci√≥n: ${classification.category}`, "bg-blue-100 text-blue-800 p-3 font-bold");

                // 2. Generar el contenido HTML de la tabla de resultados
                const tableContent = generateResultsTableHTML(finalScore, classification);

                // 3. Mostrar el modal de resultados
                showCustomModal(`Evaluaci√≥n completada. Distancia total: ${distance} km.`, tableContent, true);
            } else {
                // Este caso ocurre cuando el usuario presiona "Hacer Escala" (Detener)
                const pauseMessage = "Te detuviste antes de finalizar el viaje. Vuelve a Zarpar para continuar.";
                showCustomModal("Misi√≥n Pausada (Hacer Escala)", pauseMessage);
            }
            
            // Estilos de reinicio
            boatIcon.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            boatIcon.style.opacity = '1';

            startButton.textContent = "Reiniciar Simulaci√≥n";
            startButton.classList.remove('bg-red-600');
            startButton.classList.add('bg-blue-600');
            
            renderMarkers(); 
        }

        // --- Inicializaci√≥n ---
        window.onload = function() {
            updateStatus(); // Inicializar el display
            boatIcon.style.transform = `translateX(10%)`;
        };
    </script>
</body>
</html>
